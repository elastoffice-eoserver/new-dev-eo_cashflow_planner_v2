<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>

        <!--
        ========================================================================
        BUDGET VIEWS - Cashflow Planning Budgets
        ========================================================================

        Pattern Used: patterns/views/form-view.xml
        Pattern Used: patterns/views/tree-view.xml
        Pattern Used: patterns/views/search-view.xml
        Pattern Used: patterns/views/menu-action.xml

        Purpose: CRUD interface for budget management
        -->

        <!-- ================================================================ -->
        <!-- FORM VIEW -->
        <!-- ================================================================ -->

        <record id="eo_cfp_budget_form_view" model="ir.ui.view">
            <field name="name">eo.cfp.budget.form</field>
            <field name="model">eo.cfp.budget</field>
            <field name="arch" type="xml">
                <form string="Budget" version="7.0">
                    <header>
                        <!-- State workflow buttons -->
                        <button name="action_confirm" string="Confirm" type="object"
                                states="draft" class="oe_highlight"/>
                        <button name="action_close" string="Close" type="object"
                                states="confirmed" class="oe_highlight"/>
                        <button name="action_reopen" string="Reopen" type="object"
                                states="closed"/>
                        <button name="action_set_to_draft" string="Reset to Draft" type="object"
                                states="confirmed,closed"/>
                        <field name="state" widget="statusbar"
                               statusbar_visible="draft,confirmed,closed"/>
                    </header>

                    <sheet>
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1>
                                <field name="name" placeholder="e.g. Q1 2025 Marketing Budget"/>
                            </h1>
                        </div>

                        <group>
                            <group>
                                <field name="category_id"
                                       context="{'tree_view_ref': 'eo_cashflow_planner_v2.eo_cfp_category_tree_view'}"/>
                                <field name="planned_amount" widget="monetary"
                                       options="{'currency_field': 'currency_id'}"/>
                                <field name="currency_id" groups="base.group_multi_currency"/>
                            </group>
                            <group>
                                <field name="period_start"/>
                                <field name="period_end"/>
                                <field name="active"/>
                            </group>
                        </group>

                        <group string="Budget Usage">
                            <group>
                                <field name="used_amount" widget="monetary"
                                       options="{'currency_field': 'currency_id'}"/>
                                <field name="remaining_amount" widget="monetary"
                                       options="{'currency_field': 'currency_id'}"/>
                            </group>
                            <group>
                                <!-- Usage percentage could be added here as computed field -->
                                <label string="Used amount is calculated from planned items in this category and period"/>
                            </group>
                        </group>

                        <notebook>
                            <page string="Internal Notes">
                                <field name="notes" placeholder="Notes about this budget, usage restrictions, etc."/>
                            </page>
                        </notebook>
                    </sheet>

                    <!-- Chatter (messaging/followers) - Odoo 7 doesn't support this well, removed -->
                </form>
            </field>
        </record>

        <!-- ================================================================ -->
        <!-- TREE VIEW -->
        <!-- ================================================================ -->

        <record id="eo_cfp_budget_tree_view" model="ir.ui.view">
            <field name="name">eo.cfp.budget.tree</field>
            <field name="model">eo.cfp.budget</field>
            <field name="arch" type="xml">
                <tree string="Budgets"
                      colors="blue:state=='draft';green:state=='confirmed';gray:state=='closed' or active==False">
                    <field name="name"/>
                    <field name="category_id"/>
                    <field name="period_start"/>
                    <field name="period_end"/>
                    <field name="planned_amount" sum="Total Planned"/>
                    <field name="used_amount" sum="Total Used"/>
                    <field name="remaining_amount" sum="Total Remaining"/>
                    <field name="currency_id" groups="base.group_multi_currency"/>
                    <field name="state"/>
                    <field name="active" invisible="1"/>
                </tree>
            </field>
        </record>

        <!-- ================================================================ -->
        <!-- SEARCH VIEW -->
        <!-- ================================================================ -->

        <record id="eo_cfp_budget_search_view" model="ir.ui.view">
            <field name="name">eo.cfp.budget.search</field>
            <field name="model">eo.cfp.budget</field>
            <field name="arch" type="xml">
                <search string="Search Budgets">
                    <!-- Search fields -->
                    <field name="name"
                           filter_domain="['|', ('name', 'ilike', self), ('notes', 'ilike', self)]"/>
                    <field name="category_id"/>

                    <!-- Filters -->
                    <filter string="Draft" name="filter_draft"
                            domain="[('state', '=', 'draft')]"
                            icon="terp-document-new"/>
                    <filter string="Confirmed" name="filter_confirmed"
                            domain="[('state', '=', 'confirmed')]"
                            icon="terp-check"
                            help="Active budgets"/>
                    <filter string="Closed" name="filter_closed"
                            domain="[('state', '=', 'closed')]"
                            icon="terp-dialog-close"/>

                    <separator/>

                    <filter string="Active" name="filter_active"
                            domain="[('active', '=', True)]"/>
                    <filter string="Archived" name="filter_inactive"
                            domain="[('active', '=', False)]"/>

                    <separator/>

                    <filter string="Over Budget" name="filter_over_budget"
                            domain="[('remaining_amount', '&lt;', 0)]"
                            help="Budgets that have been exceeded"/>
                    <filter string="Within Budget" name="filter_within_budget"
                            domain="[('remaining_amount', '&gt;=', 0)]"
                            help="Budgets with remaining amount"/>

                    <separator/>

                    <filter string="Current Month" name="filter_current_month"
                            domain="[('period_start', '&lt;=', time.strftime('%%Y-%%m-%%d')),
                                     ('period_end', '&gt;=', time.strftime('%%Y-%%m-%%d'))]"
                            help="Budgets covering current date"/>

                    <!-- Group By -->
                    <group expand="0" string="Group By">
                        <filter string="Category" name="group_category"
                                context="{'group_by': 'category_id'}"/>
                        <filter string="State" name="group_state"
                                context="{'group_by': 'state'}"/>
                        <filter string="Start Date" name="group_start_date"
                                context="{'group_by': 'period_start'}"/>
                        <filter string="Currency" name="group_currency"
                                context="{'group_by': 'currency_id'}"
                                groups="base.group_multi_currency"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ================================================================ -->
        <!-- ACTION -->
        <!-- ================================================================ -->

        <record id="action_eo_cfp_budget" model="ir.actions.act_window">
            <field name="name">Budgets</field>
            <field name="res_model">eo.cfp.budget</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="view_id" ref="eo_cfp_budget_tree_view"/>
            <field name="search_view_id" ref="eo_cfp_budget_search_view"/>
            <field name="context">{'search_default_filter_active': 1, 'search_default_filter_confirmed': 1}</field>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to create a new budget.
                </p>
                <p>
                    Budgets allow you to plan and track spending per category over specific time periods.
                    The system automatically calculates used amounts based on planned items.
                </p>
                <p>
                    <b>Workflow:</b>
                </p>
                <ul>
                    <li><b>Draft:</b> Budget being prepared</li>
                    <li><b>Confirmed:</b> Budget active and monitored</li>
                    <li><b>Closed:</b> Budget period finished</li>
                </ul>
            </field>
        </record>

        <!-- Menu item defined in views/eo_cfp_menu.xml -->

    </data>
</openerp>
